# Vouchers

## Алгоритм заездных ~~и ежедневных~~ планов

Скрипт упаковывается в Docker контейнер, автоматически запускается 
используя следующие переменные окружения:

- **AMQP_URL** — полный адрес сервер RabbitMQ для подключения, 
  например: `amqp://user:password@domain:5672?parameters=value`

- **QUEUE_NAME_REQUEST** — имя очереди из которой скрипт будет получать входные 
  данные для формирования ответа.
  
- **QUEUE_NAME_RESPONSE** — имя очереди в которую скрипт отправит результат 
  формирования плана.
  
- *PREFETCH_COUNT* — не обязательный параметр настройки подключения, 
  используется для распределения нагрузки, по-умолчанию равен 1.

- **VOUCHERS_URL** — URL по которому скрипт будет получать крайний 
  номер путёвки.

Алгоритм работает с очередью RabbitMQ, возвращает ответ в тот же канал 
очереди через которую получен запрос, но в другую очередь.

---

**ВНИМАНИЕ!** Тестирование показало, что ответ может получиться клиент
не с первой попытке, по этой причине, рекомендуется выполнять до 10
запросов подряд до момента получения ответа.

---

Алгоритм ожидает в указанной очереди (параметр `QUEUE_NAME_REQUEST`) сообщения 
следующей JSON структуры:

```json5
{
  "id": 0, // Используется в поле voucher_release_plan_id
  "operational_plan": {
    "id": 0,
    "sanatorium_id": 0, // Идентификатор санатория, используется в поле sanatorium_id
    "name": "Наименование санатория",
    "date_from": "2021-01-01", // Дата начала формирования плана
    "date_to": "2021-04-09", // Дата окончания формирования плана
    "department": {
      "num_of_beds": 300, // Кол-во койкомест в отделении
      "department_id": 0 // Идентификатор отделения, используется в поле department_id
    }
  },
  "plan_type": {
    "id": 0,
    "code": 0, // Тип плана: 1 — ежедневный, 2 — заездный
    "name": "Название плана"
  },
  "number_days_between_arrivals": 0, // кол-во дней между заездами, используется в поле days_between_arrivals_count
  "non_arrival_days": [ // не заездные дни недели 
    {
      "code": 0, // Номер дня недели, 1 — понедельник, 7 — воскресенье
      "name": "название дня недели"
    }
  ],
  "sanitary_days": 0, // Санитарные дни, используется в поле sanitary_days_count
  "number_arrival_days": 0, // Кол-во заездных дней
  "comment": "Комментарий к плану заезда",
  "status": {
    "id": 0,
    "code": 0,
    "name": "Описание статуса"
  }
}
```

Поля имеющие комментарии обязательны для корректной работы алгоритма. 
Они должны присутствовать в JSON сообщении. Типы полей также должны
соответствовать выше описанному примеру.

Результатом работы алгоритма будет один из ниже описанных примеров 
в разделе "Тестирование" данного документа.

## Тестирование

Перед тестированием необходимо выполнить установку виртуального окружения 
с версией Python 3.9 и установки зависимых пакетов:

```shell
$ pip install -r requirements.txt
```

В каталоге содержится 2 файла для тестирования алгоритма:

- `test.py` — запускается с помощью команды: `streamlit run test.py`. 
  Откроет браузер с визуальной настройкой и сводной таблицей,
  для ручного тестирования.
  
- `receiver.py` — запускается получатель планов, перед запуском следующего 
  тестового скрипта, командой: `python receiver.py`. Используется только в 
  связке с запущенными контейнерами, описанными в файле `docker-compose.yml` 
  (запускается командой: `docker-compose up -d`).
  
- `publisher.py` — скрипт отправляет в очередь запрос на формирование плана. 
  Запускается с помощью команды: `python publicher.py`, но перед этим 
  необходимо запустить получатель планов. Используется только в связке с 
  получателем планов и запущенными контейнерами, описанными в 
  файле `docker-compose.yml` (запускается командой: `docker-compose up -d`).
  
**ВНИМАНИЕ!** Если не будет запущен получатель планов, то результат работы скрипта 
будет не доступен. В рабочей среде получатель планов должен также находить в
режиме ожидания сообщений.
  
При запущенном `receiver.py` и запуске `publisher.py` вы должны увидеть в консоле, 
где запущен `receiver.py` декодированный JSON объект следующего типа:

**Пример корректного завершения:**

```json
{
  "success": true,
  "data": [
    {
      "voucher_release_plan_id": 1,
      "sanatorium_id": 1,
      "department_id": 1,
      "arrival_number": 1,
      "arrival_day_number": 1,
      "arrival_date": "2021-01-01",
      "days_of_stay_count": 14,
      "departure_date": "2021-01-15",
      "vouchers_count": 60,
      "voucher_number_from": 1,
      "voucher_number_to": 60,
      "days_between_arrivals_count": 1,
      "sanitary_days_count": 2,
      "status": 1
    }
  ]
}
```

**Пример не корректного завершения:**

```json
{
  "success": false,
  "data": {
    "error_msg": "Описание ошибки.",
    "voucher_release_plan_id": 0
  }
}
```

## TODO:

- [ ] Добавить коды ошибок, а не только статус и сообщение.
